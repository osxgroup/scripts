#!/bin/bash


## these are defaults
## your settings should go in awl.conf so they are not overwritten when this script is updated

# Domains excluded from whitelist
EXCLUDE_DOMAINS='linkedin.com'
AWL_TTL='30'
SA_DIR='/Library/Server/Mail/Config/spamassassin'
STAMP=$(date "+%Y-%m-%d")


#########################################################################################
######## SCRIPT
#########################################################################################


die() { echo "$*"; exit 1; } >&2
msg() { [ -t 1 ] && printf "$@\n" ; }
pvar() { for i in $@; do echo "$i = ${!i}"; done ; }

[ `whoami` != "root" ] && die "$MY_NAME must be run as root user."

export PATH="/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin:/Applications/Server.app/Contents/ServerRoot/usr/bin:/Applications/Server.app/Contents/ServerRoot/usr/sbin"

which serveradmin &>/dev/null || die "Error: Could not find serveradmin"

DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"  
cd "${DIR}"/.. || die "Error: cd ${DIR}"

[ -f awl.conf ] && source awl.conf || touch awl.conf || die "Error: permissions of ${DIR}"

# Get local domains which we exclude from awl
DOMAINS=$(serveradmin settings mail | grep -E "postfix:(mydestination:_array_index|virtual_domains:_array_index|mydomain|myhostname)" | cut -f2 -d\" | sed '/^\$/d' |  perl -pe 's/\n/|/')
# delete the last pipe
DOMAINS=$(echo $DOMAINS | rev | cut -c 2- | rev)
[ -n "$EXCLUDE_DOMAINS" ] && DOMAINS="$DOMAINS|$EXCLUDE_DOMAINS"
[ -z "$DOMAINS" ] && die "Error: DOMAINS=${DOMAINS}"

msg "Updating AWL excluding these domains: ${DOMAINS}"

cd data || dir "Error: cd ${DIR}/data"

# purge old awl log files
msg "Deleting awl log files older than $AWL_TTL days"
#find . -name "mailout_*.log" -mtime +"$AWL_TTL"d
find . -name "mailout_*.log" -mtime +"$AWL_TTL"d -delete

# addresses are sorted, de-duped and excluded domains are removed
cat  mailout_*.log | awk '{print $3}' | grep -viE $DOMAINS | tr '[:upper:]' '[:lower:]' | sort -u | perl -ne'if(/[\w\.\-\_]+@([\w\-\_]+\.)+[A-Za-z]{2,4}/g){print "$&\n"}' > awl.txt

# generate spamassassin whitelist
echo "# Automatically generated by topicdesk_awl - `date +"%Y-%m-%d  -  %H:%M:%S"`" > awl.sa
sed 's/^/whitelist_from /' awl.txt >> awl.sa
mv awl.sa "$SA_DIR/z_awl.cf" || die "Error: mv awl.sa $SA_DIR/z_awl.cf"
launchctl list | grep "org.amavis.amavisd$" >/dev/null && (launchctl stop org.amavis.amavisd; echo "amavisd restarted") || echo "amavisd not running"

exit 0
